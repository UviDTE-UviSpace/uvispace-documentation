<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>The uvisensor package &#8212; UviSpace 1.0.0 documentation</title>
    
    <link rel="stylesheet" href="_static/agogo.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="top" title="UviSpace 1.0.0 documentation" href="index.html" />
    <link rel="next" title="Introduction" href="Hardware.html" />
    <link rel="prev" title="The uvirobot package" href="uvirobot.html" /> 
  </head>
  <body role="document">
    <div class="header-wrapper" role="banner">
      <div class="header">
        <div class="headertitle"><a
          href="index.html">UviSpace 1.0.0 documentation</a></div>
        <div class="rel" role="navigation" aria-label="related navigation">
          <a href="uvirobot.html" title="The uvirobot package"
             accesskey="P">previous</a> |
          <a href="Hardware.html" title="Introduction"
             accesskey="N">next</a> |
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a>
        </div>
       </div>
    </div>

    <div class="content-wrapper">
      <div class="content">
        <div class="document">
            
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="the-uvisensor-package">
<h1>The uvisensor package<a class="headerlink" href="#the-uvisensor-package" title="Permalink to this headline">¶</a></h1>
<div class="section" id="module-uvisensor.multiplecamera">
<span id="multiplecamera-py"></span><h2>multiplecamera.py<a class="headerlink" href="#module-uvisensor.multiplecamera" title="Permalink to this headline">¶</a></h2>
<p>Multithreading routine for controlling external FPGAs with cameras.</p>
<p>The module creates several parallel threads, in order to optimize the 
execution time, as it contains several instructions which require 
waiting for external resources before continuing execution e.g. waiting 
for the TCP/IP client to deliver FPGA registers information. Namely, 6 
different threads are managed and indexed in a list called <em>threads</em>:</p>
<ul class="simple">
<li>4 threads that run the 4 FGPAs initialization routines. Afterwards,
endless loops continually request the UGVs&#8217; positions to each FPGA.</li>
<li>Another thread that interacts with the user through keyboard. It reads
input commands and performs corresponding actions.</li>
<li>A final thread is in charge of merging the information obtained at
each FPGA thread and obtain global UGVs&#8217; positions.</li>
</ul>
<p>NOTE: The proper way to end the program is to press &#8216;Q&#8217;, as the terminal
prompt indicates during execution. If the Keyboard Interrupt is used 
instead, it will probably corrupt the TCP/IP socket and the FPGAs will 
have to be reset.</p>
<hr class="docutils" />
<a class="reference internal image-reference" href="_images/Multiplecamera_Flowcharts2.png"><img alt="_images/Multiplecamera_Flowcharts2.png" src="_images/Multiplecamera_Flowcharts2.png" style="height: 700px;" /></a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<a class="reference internal image-reference" href="_images/Multiplecamera_Flowcharts1.png"><img alt="_images/Multiplecamera_Flowcharts1.png" src="_images/Multiplecamera_Flowcharts1.png" style="height: 700px;" /></a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<dl class="class">
<dt id="uvisensor.multiplecamera.CameraThread">
<em class="property">class </em><code class="descclassname">uvisensor.multiplecamera.</code><code class="descname">CameraThread</code><span class="sig-paren">(</span><em>triangles</em>, <em>ntriangles</em>, <em>begin_event</em>, <em>end_event</em>, <em>condition</em>, <em>inborders</em>, <em>reset_flag</em>, <em>name=None</em>, <em>conf_file=''</em><span class="sig-paren">)</span><a class="headerlink" href="#uvisensor.multiplecamera.CameraThread" title="Permalink to this definition">¶</a></dt>
<dd><p>Child class of threading.Thread for capturing frames from a camera.</p>
<p>The <em>run</em> method, where is specified the behavior when the <em>start</em> 
method is called, is overrided. At first, it loads the FPGA 
configuration. Then it enters an endless loop until <em>end_event</em> 
flag is raised. At each iteration, when possible, reads the FPGA 
register containing triangles location, processes the data and 
writes it to the global shared variable <em>triangles</em>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>triangles</strong> &#8211; Dictionary where each element is an instance 
of geometry.Triangle(). It is a global variable for sharing the 
information of different triangles detected in the camera space. 
Each triangle has a UNIQUE key identifier. It is used for 
writing and sending to other threads the triangle elements.</li>
<li><strong>ntriangles</strong> &#8211; READ ONLY dictionary of the same type and shape 
as <em>triangles</em>. It contains the triangles detected by other cameras 
that are inside the borders region of the current camera&#8217;s space.</li>
<li><strong>begin_event</strong> &#8211; threading.Event() object that is set to True 
when the FPGA is configured and the thread begins the main loop.</li>
<li><strong>end_event</strong> &#8211; threading.Event() object that is set to True 
when the execution has to end.</li>
<li><strong>condition</strong> &#8211; threading.Condition() object for synchronizing 
R/W operations on shared variables i.e. triangles, inborders.</li>
<li><strong>inborders</strong> &#8211; READ ONLY dictionary whose elements indicate if 
the corresponding triangle is located within the borders region 
of current camera&#8217;s space. Its keys have an univocal correspondence 
with the key identifiers of the <em>triangles</em> dictionary.</li>
<li><strong>name</strong> &#8211; String that provides the name of the thread.</li>
<li><strong>conf_file</strong> &#8211; String containing the relative path to the 
configuration file of the camera.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="class">
<dt id="uvisensor.multiplecamera.DataFusionThread">
<em class="property">class </em><code class="descclassname">uvisensor.multiplecamera.</code><code class="descname">DataFusionThread</code><span class="sig-paren">(</span><em>triangles</em>, <em>ntriangles</em>, <em>conditions</em>, <em>inborders</em>, <em>quadrant_limits</em>, <em>begin_events</em>, <em>end_event</em>, <em>reset_flags</em>, <em>publisher</em>, <em>name='Fusion Thread'</em><span class="sig-paren">)</span><a class="headerlink" href="#uvisensor.multiplecamera.DataFusionThread" title="Permalink to this definition">¶</a></dt>
<dd><p>Child class of threading.Thread for merging and processing data.</p>
<p>Override the <em>run</em> method, where it is specified the behavior 
when the <em>start</em> method is called. At first, wait until all cameras 
are initialized. After that, enter an endless loop until <em>end_event</em> 
flag is raised. At each iteration:</p>
<ul class="simple">
<li>Check the triangles stored at each CameraThread.</li>
<li>When a triangle is detected, determine if it is in the borders 
region of another camera. If True, prepare a new ROI tracker.</li>
<li>Evaluate if an UGV exits a camera, deleting the ROI tracker if 
it is True.</li>
<li>Merge the information obtained in all the cameras and write it in 
a ROS topic</li>
</ul>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>triangles</strong> &#8211; READ ONLY List containing N dictionaries, where
N is the number of Camera threads. Each dictionary entry are the
coordinates of an UGV inside the Nth camera.</li>
<li><strong>ntriangles</strong> &#8211; WRITE N-len list of the shame type and shape as
triangles, for exchanging triangles information between 
CameraThreads.</li>
<li><strong>conditions</strong> &#8211; List containing N threading.Condition objects. 
They are used for synchronizing the CameraThreads and the
DataFusionThread when doing R/W operations on shared variables.</li>
<li><strong>inborders</strong> &#8211; List containing N dictionaries. Each dictionary
entry is a flag set to True when the UGV is in the Nth camera 
borders region.</li>
<li><strong>quadrant_limits</strong> &#8211; List containing N 4x2 arrays. Each array 
contains the 4 points defining the working space of the Nth camera.</li>
<li><strong>end_event</strong> &#8211; threading.Event object that is set to True when 
the UserThread detects an &#8216;end&#8217; order from the user.</li>
<li><strong>publisher</strong> &#8211; rospy.Publisher object for sending pose values to 
a ROS topic, that can be read by other ROS nodes.</li>
<li><strong>reset_flags</strong> &#8211; List containing N dictionaries whose entries are
flags set to True when a ROI tracker in specified FPGA to be reset.</li>
<li><strong>name</strong> &#8211; String containing the name of the current thread.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="class">
<dt id="uvisensor.multiplecamera.UserThread">
<em class="property">class </em><code class="descclassname">uvisensor.multiplecamera.</code><code class="descname">UserThread</code><span class="sig-paren">(</span><em>begin_events</em>, <em>end_event</em>, <em>name='User Thread'</em><span class="sig-paren">)</span><a class="headerlink" href="#uvisensor.multiplecamera.UserThread" title="Permalink to this definition">¶</a></dt>
<dd><p>Child class of threading.Thread for interacting with user.</p>
<p>Override the <em>run</em> method, where it is specified the behavior 
when the <em>start</em> method is called. Ask the user for commands through
keyboard.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>begin_events</strong> &#8211; List with N Event objects, where N is the 
number of Camera threads. Until the set up of every camera is 
finished, the user can not interact with this thread.</li>
<li><strong>end_event</strong> &#8211; threading.Event object that is set to True when 
the UserThread detects an &#8216;end&#8217; order from the user.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="module-uvisensor.client">
<span id="client-py"></span><h2>client.py<a class="headerlink" href="#module-uvisensor.client" title="Permalink to this headline">¶</a></h2>
<p>This module contains the Client class, which inherits from socket.socket</p>
<ul class="simple">
<li>socket.socket class source code can be found in the folowing link:
<a class="reference external" href="https://hg.python.org/cpython/file/2.7/Lib/socket.py">https://hg.python.org/cpython/file/2.7/Lib/socket.py</a></li>
<li>This class is a child of the _socket.socket class. 
Its source code can be found in the following link:
<a class="reference external" href="https://github.com/biosbits/bits/blob/master/python/_socket.py">https://github.com/biosbits/bits/blob/master/python/_socket.py</a></li>
</ul>
<hr class="docutils" />
<div class="line-block">
<div class="line"><br /></div>
</div>
<dl class="class">
<dt id="uvisensor.client.Client">
<em class="property">class </em><code class="descclassname">uvisensor.client.</code><code class="descname">Client</code><span class="sig-paren">(</span><em>buffer_size=2048</em>, <em>timeout=2.0</em><span class="sig-paren">)</span><a class="headerlink" href="#uvisensor.client.Client" title="Permalink to this definition">¶</a></dt>
<dd><p>Child class of socket.socket which includes register operations.</p>
<p>It is intended to work with registers of a device, namely of an 
FPGA. The register identifiers must correspond with the ones of the
designed HDL circuit.</p>
<p>Used methods from parent class:</p>
<ul class="simple">
<li>connect((host, port)) : connects to a remote address</li>
<li>close()</li>
<li>send(data)</li>
<li>recv(buflen) : read the specified number of bytes</li>
<li>settimeout(timeout)</li>
</ul>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>buffer_size</strong> &#8211; int containing the size, in bytes, of the buffer
for the incomming data.</li>
<li><strong>timeout</strong> &#8211; int or float containing the value, in seconds, of 
the time that will be waited for reading incoming data. This will 
set the object to timeout mode (By default, it is set to blocking 
mode)</li>
</ul>
</td>
</tr>
</tbody>
</table>
<dl class="method">
<dt id="uvisensor.client.Client.close_connection">
<code class="descname">close_connection</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#uvisensor.client.Client.close_connection" title="Permalink to this definition">¶</a></dt>
<dd><p>Send close command to device and close connection.</p>
<p>Write &#8216;Q&#8217; to FPGA register and call Socket.close() method.</p>
</dd></dl>

<dl class="method">
<dt id="uvisensor.client.Client.open_connection">
<code class="descname">open_connection</code><span class="sig-paren">(</span><em>ip</em>, <em>port</em><span class="sig-paren">)</span><a class="headerlink" href="#uvisensor.client.Client.open_connection" title="Permalink to this definition">¶</a></dt>
<dd><p>Create the socket connection.</p>
<p>After connecting, the input buffer is read for emptying it.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>ip</strong> &#8211; String with the IP adress of the device.</li>
<li><strong>port</strong> &#8211; int indicating the socket port.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="uvisensor.client.Client.read_data">
<code class="descname">read_data</code><span class="sig-paren">(</span><em>size</em><span class="sig-paren">)</span><a class="headerlink" href="#uvisensor.client.Client.read_data" title="Permalink to this definition">¶</a></dt>
<dd><p>Read N packages and return a cocatenation of all of them.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>size</strong> &#8211; int indicating number of bytes to be read.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="uvisensor.client.Client.read_register">
<code class="descname">read_register</code><span class="sig-paren">(</span><em>regkey</em><span class="sig-paren">)</span><a class="headerlink" href="#uvisensor.client.Client.read_register" title="Permalink to this definition">¶</a></dt>
<dd><p>Read the value of a register.</p>
</dd></dl>

<dl class="method">
<dt id="uvisensor.client.Client.write_command">
<code class="descname">write_command</code><span class="sig-paren">(</span><em>command</em>, <em>clean_buffer=False</em><span class="sig-paren">)</span><a class="headerlink" href="#uvisensor.client.Client.write_command" title="Permalink to this definition">¶</a></dt>
<dd><p>Send a command to the TCP/IP client.</p>
<p>Set the clean_buffer arg to True for doing a clean-up reading 
after writing.</p>
</dd></dl>

<dl class="method">
<dt id="uvisensor.client.Client.write_register">
<code class="descname">write_register</code><span class="sig-paren">(</span><em>regkey</em>, <em>value</em><span class="sig-paren">)</span><a class="headerlink" href="#uvisensor.client.Client.write_register" title="Permalink to this definition">¶</a></dt>
<dd><p>Write a value into a register and clean up input buffer.</p>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="geometry-py">
<h2>geometry.py<a class="headerlink" href="#geometry-py" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="imgprocessing-py">
<h2>imgprocessing.py<a class="headerlink" href="#imgprocessing-py" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="videosensor-py">
<h2>videosensor.py<a class="headerlink" href="#videosensor-py" title="Permalink to this headline">¶</a></h2>
</div>
</div>


          </div>
        </div>
      </div>
        </div>
        <div class="sidebar">
          <h3>Table Of Contents</h3>
          <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="Starting.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="uvirobot.html">Uvirobot package</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Uvisensor package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#module-uvisensor.multiplecamera">multiplecamera.py</a></li>
<li class="toctree-l2"><a class="reference internal" href="#module-uvisensor.client">client.py</a></li>
<li class="toctree-l2"><a class="reference internal" href="#geometry-py">geometry.py</a></li>
<li class="toctree-l2"><a class="reference internal" href="#imgprocessing-py">imgprocessing.py</a></li>
<li class="toctree-l2"><a class="reference internal" href="#videosensor-py">videosensor.py</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Hardware.html">Hardware design</a></li>
<li class="toctree-l1"><a class="reference internal" href="Arduino.html">Arduino controller</a></li>
</ul>

          <div role="search">
            <h3 style="margin-top: 1.5em;">Search</h3>
            <form class="search" action="search.html" method="get">
                <input type="text" name="q" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
            </form>
          </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

    <div class="footer-wrapper">
      <div class="footer">
        <div class="left">
          <div role="navigation" aria-label="related navigaton">
            <a href="uvirobot.html" title="The uvirobot package"
              >previous</a> |
            <a href="Hardware.html" title="Introduction"
              >next</a> |
            <a href="py-modindex.html" title="Python Module Index"
              >modules</a> |
            <a href="genindex.html" title="General Index"
              >index</a>
          </div>
          <div role="note" aria-label="source link">
              <br/>
              <a href="_sources/uvisensor.txt"
                rel="nofollow">Show Source</a>
          </div>
        </div>

        <div class="right">
          
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Javier Lopez-Randulfe.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.8.
    </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

  </body>
</html>